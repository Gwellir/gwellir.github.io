<html lang="en">
  <head>
    <!-- Load the Telegram Library -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!--Load the VueJS Library-->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <style>
      .candidates {
        background-color: #ddd;
      }
      .candidate_card {
        border: 1px solid black;
      }
      .selected {
        background-color: #aaa;
        outline: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>Voting</h1>
      <h4>Candidates</h4>
      <!-- Список кандидатов, отображение img, name, source, после сидинга, вероятно, seed number -->
      <div class="candidates">
        <div class="candidate_card" :class="{selected: candidate.selected}" v-for="candidate of candidates" :key="candidate.mal_cid"  @click="swapSelection(candidate)">
            <img :src="candidate.img" :alt="candidate.name" height=150px>
            <p>{{candidate.name}} ({{candidate.source}})</p>
        </div>
      </div>
    </div>
    <script>
      const app = new Vue({
        el: '#app',
        data: {
          webApp: window.Telegram.WebApp,
          candidates: [],
          stage: null,
          user_data: null,
          user_votes: null,
        },
        methods: {
          swapSelection(candidate) {
            candidate.selected = !candidate.selected;
            // HapticFeedback вроде бы не работал, как минимум, у меня на телефоне
            window.Telegram.WebApp.HapticFeedback.selectionChanged();
          },
          // возвращает строку из 1 и 0, в соответствии со свойством selected для кандидатов по порядку
          getSelectedString() {
            resultStr = '';
            for (c of this.candidates) {
              if (c.selected)
                resultStr += "1";
              else
                resultStr += "0";
            }
            console.log(resultStr);
            return resultStr;
          },
          initFromJson(data) {
            this.candidates = data.candidates;
            this.stage = data.stage;
          },
          // выставляет свойство selected кандидатам в зависимости от полученной в GET параметре 
          // votes строки голосов текущего юзера
          // строки может не быть, или она может относиться к другому туру
          unpackVotes(voteString) {
            if (!voteString)
              return;
            else if (voteString.length != this.candidates.length)
              return;
            else {
              for (i=0; i<this.candidates.length; i++)
                this.candidates[i].selected = (voteString[i] === "1")
            }
          }
        },
        mounted(){
          // загрузка данных кандидатов из data.json
          axios.get('data.json')
            .then(response => (this.initFromJson(response.data)))
            .catch(error => (console.log(error)));
          // получение строки с голосами из GET параметра 'votes'
          const urlParams = new URLSearchParams(window.location.search);
          const votes = urlParams.get('votes');
          this.unpackVotes(votes);
        },
        computed: {},
      });
      // Инициализация кнопки для отправки данных обратно боту
      const mainButton = window.Telegram.WebApp.MainButton;
      mainButton.text = "Send Votes";
      mainButton.enable();
      mainButton.show();
      mainButton.onClick(function() {
        window.Telegram.WebApp.sendData(app.getSelectedString());
      });
    </script>
  </body>
</html>
