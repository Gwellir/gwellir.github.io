<html lang="en">
  <head>
    <!-- Load the Telegram Library -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!--Load the VueJS Library-->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <style>
      .selected {
        background-color: #ddd;
        outline: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>Voting</h1>
      <h4>Candidates</h4>
      <div class="candidates">
        <div class="candidate_card" :class="{selected: candidate.selected}" v-for="candidate of candidates" :key="candidate.mal_cid">
            <img :src="candidate.img" :alt="candidate.name" height=150px @click="swapSelection(candidate)">
            <p>{{candidate.name}} ({{candidate.source}})</p>
        </div>
      </div>
      <p>{{selectedString}}</p>
    </div>
    <script>
      const app = new Vue({
        el: '#app',
        data: {
          webApp: window.Telegram.WebApp,
          candidates: [],
          stage: null,
          user_data: null,
          user_votes: null,
        },
        methods: {
          swapSelection(candidate) {
            candidate.selected = !candidate.selected;
            window.Telegram.HapticFeedback.selectionChanged();
          },
          getSelected() {
            resultStr = '';
            for (c of this.candidates) {
              if (c.selected)
                resultStr = `${resultStr}1`;
              else
                resultStr = `${resultStr}0`;
            }
            console.log(resultStr);
          },
          initFromJson(data) {
            this.candidates = data.candidates;
            this.stage = data.stage;
            // this.user_data = this.WebApp.initData;
            const urlParams = new URLSearchParams(window.location.search);
            const votes = urlParams.get('votes');
            this.unpackVotes(votes);
          },
          unpackVotes(voteString) {
            if (!voteString)
              return;
            else if (voteString.length != this.candidates.length)
              return;
            else {
              for (i=0; i<this.candidates.length; i++)
                this.candidates[i].selected = (voteString[i] === "1")
            }
          }
        },
        mounted(){
          axios.get('data.json')
            .then(response => (this.initFromJson(response.data)))
            .catch(error => (console.log(error)));
        },
        computed: {
          selectedString() {
            let resultStr = '';
            for (c of this.candidates) {
              if (c.selected)
                resultStr = `${resultStr}1`;
              else
                resultStr = `${resultStr}0`;
            }
            return resultStr;
          },
        },
      });
      window.Telegram.WebApp.setBackgroundColor("#FFFFFF");
      const mainButton = window.Telegram.WebApp.MainButton;
      mainButton.text = "Send Votes";
      mainButton.enable();
      mainButton.show();
      mainButton.onClick(function() {
        window.Telegram.WebApp.sendData(app.selectedString);
      });
    </script>
  </body>
</html>
